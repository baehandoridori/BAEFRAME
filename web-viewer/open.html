<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAEFRAME - íŒŒì¼ ì—´ê¸°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .container {
      text-align: center;
      max-width: 400px;
    }

    .logo {
      font-size: 3rem;
      font-weight: bold;
      background: linear-gradient(135deg, #4a9eff, #ff4a9e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #888;
      margin-bottom: 2rem;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 3px solid #333;
      border-top-color: #4a9eff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .status-detail {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: transform 0.2s, opacity 0.2s;
      text-align: center;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, #4a9eff, #4aff9e);
      color: #000;
      font-weight: bold;
    }

    .btn-secondary {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
    }

    .hidden {
      display: none !important;
    }

    .platform-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: rgba(74, 158, 255, 0.2);
      border: 1px solid rgba(74, 158, 255, 0.5);
      border-radius: 20px;
      font-size: 0.8rem;
      color: #4a9eff;
      margin-bottom: 1rem;
    }

    .error-message {
      background: rgba(255, 74, 74, 0.2);
      border: 1px solid rgba(255, 74, 74, 0.5);
      padding: 1rem;
      border-radius: 8px;
      color: #ff6b6b;
      margin-bottom: 1.5rem;
    }

    /* ìˆ¨ê²¨ì§„ iframe (ì•± ì—´ê¸° ì‹œë„ìš©) */
    #appLauncher {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">BAEFRAME</div>
    <div class="subtitle">ì˜ìƒ ë¦¬ë·° í˜‘ì—… ë„êµ¬</div>

    <div id="platformBadge" class="platform-badge"></div>

    <div id="loadingState">
      <div class="loader"></div>
      <div class="status" id="statusText">íŒŒì¼ ì •ë³´ í™•ì¸ ì¤‘...</div>
      <div class="status-detail" id="statusDetail"></div>
    </div>

    <div id="errorState" class="hidden">
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div id="buttons" class="buttons hidden">
      <a href="#" id="btnOpenWeb" class="btn btn-primary">
        ğŸŒ ì›¹ ë·°ì–´ë¡œ ì—´ê¸°
      </a>
      <a href="#" id="btnOpenApp" class="btn btn-secondary">
        ğŸ–¥ï¸ ë°ìŠ¤í¬í†± ì•±ìœ¼ë¡œ ì—´ê¸°
      </a>
    </div>
  </div>

  <!-- ì•± ì—´ê¸° ì‹œë„ìš© ìˆ¨ê²¨ì§„ iframe -->
  <iframe id="appLauncher" name="appLauncher"></iframe>

  <script>
    // URL íŒŒë¼ë¯¸í„° íŒŒì‹±
    const params = new URLSearchParams(window.location.search);
    const videoUrl = params.get('video');
    const bframeUrl = params.get('bframe');

    // í”Œë«í¼ ê°ì§€
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
    const isAndroid = /Android/i.test(userAgent);
    const isMac = /Mac/i.test(userAgent) && !isMobile;
    const isWindows = /Win/i.test(userAgent);

    // UI ìš”ì†Œ
    const platformBadge = document.getElementById('platformBadge');
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const errorMessage = document.getElementById('errorMessage');
    const buttons = document.getElementById('buttons');
    const btnOpenApp = document.getElementById('btnOpenApp');
    const btnOpenWeb = document.getElementById('btnOpenWeb');
    const statusText = document.getElementById('statusText');
    const statusDetail = document.getElementById('statusDetail');
    const appLauncher = document.getElementById('appLauncher');

    // ì›¹ ë·°ì–´ URL ìƒì„±
    function getWebViewerUrl() {
      const baseUrl = window.location.href.replace(/\/open\.html.*$/, '');
      return `${baseUrl}/index.html?video=${encodeURIComponent(videoUrl)}&bframe=${encodeURIComponent(bframeUrl)}`;
    }

    // ì•± í”„ë¡œí† ì½œ URL ìƒì„±
    function getAppUrl() {
      return `baeframe://open?video=${encodeURIComponent(videoUrl)}&bframe=${encodeURIComponent(bframeUrl)}`;
    }

    // í”Œë«í¼ í‘œì‹œ
    function showPlatform() {
      if (isMobile) {
        platformBadge.textContent = isIOS ? 'ğŸ“± iOS' : 'ğŸ“± Android';
      } else if (isMac) {
        platformBadge.textContent = 'ğŸ macOS';
      } else if (isWindows) {
        platformBadge.textContent = 'ğŸªŸ Windows';
      } else {
        platformBadge.textContent = 'ğŸ’» Desktop';
      }
    }

    // URL ìœ íš¨ì„± ê²€ì‚¬
    function validateUrls() {
      if (!videoUrl || !bframeUrl) {
        showError('íŒŒì¼ URLì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ê³µìœ  ë§í¬ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return false;
      }
      return true;
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
      errorMessage.textContent = message;
      showButtons();
    }

    // ë²„íŠ¼ í‘œì‹œ
    function showButtons() {
      buttons.classList.remove('hidden');
      btnOpenWeb.href = getWebViewerUrl();
      btnOpenApp.href = getAppUrl();

      // ëª¨ë°”ì¼ì—ì„œëŠ” ì•± ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      if (isMobile) {
        btnOpenApp.classList.add('hidden');
      }
    }

    // ì›¹ ë·°ì–´ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToWebViewer() {
      console.log('ğŸŒ ì›¹ ë·°ì–´ë¡œ ì´ë™');
      window.location.replace(getWebViewerUrl());
    }

    // ë°ìŠ¤í¬í†±ì—ì„œ ì•± ì—´ê¸° ì‹œë„ (iframe ë°©ì‹)
    function tryOpenAppWithFallback() {
      statusText.textContent = 'ë°ìŠ¤í¬í†± ì•± í™•ì¸ ì¤‘...';
      statusDetail.textContent = 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';

      const appUrl = getAppUrl();
      let appOpened = false;

      // visibility changeë¡œ ì•± ì—´ë¦¼ ê°ì§€
      const handleVisibilityChange = () => {
        if (document.hidden) {
          appOpened = true;
          console.log('âœ… ì•±ì´ ì—´ë¦° ê²ƒ ê°™ìŠµë‹ˆë‹¤');
        }
      };
      document.addEventListener('visibilitychange', handleVisibilityChange);

      // blur ì´ë²¤íŠ¸ë¡œë„ ê°ì§€ (ì¼ë¶€ ë¸Œë¼ìš°ì €)
      const handleBlur = () => {
        appOpened = true;
        console.log('âœ… ì°½ì´ í¬ì»¤ìŠ¤ë¥¼ ìƒìŒ - ì•± ì—´ë¦¼');
      };
      window.addEventListener('blur', handleBlur);

      // iframeìœ¼ë¡œ ì•± ì—´ê¸° ì‹œë„ (ëŒ€í™”ìƒì ì—†ì´)
      try {
        appLauncher.src = appUrl;
      } catch (e) {
        console.log('iframe ë°©ì‹ ì‹¤íŒ¨, link ë°©ì‹ ì‹œë„');
      }

      // ìˆ¨ê²¨ì§„ ë§í¬ë¡œë„ ì‹œë„
      const link = document.createElement('a');
      link.href = appUrl;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // 1.5ì´ˆ í›„ ì•±ì´ ì•ˆ ì—´ë ¸ìœ¼ë©´ ì›¹ìœ¼ë¡œ í´ë°±
      setTimeout(() => {
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        window.removeEventListener('blur', handleBlur);

        if (!appOpened && !document.hidden) {
          console.log('âš ï¸ ì•±ì´ ì—´ë¦¬ì§€ ì•ŠìŒ, ì›¹ ë·°ì–´ë¡œ ì´ë™');
          statusText.textContent = 'ì›¹ ë·°ì–´ë¡œ ì´ë™í•©ë‹ˆë‹¤...';
          statusDetail.textContent = '';

          setTimeout(redirectToWebViewer, 500);
        }
      }, 1500);
    }

    // ë©”ì¸ ë¡œì§
    function main() {
      showPlatform();

      if (!validateUrls()) {
        return;
      }

      if (isMobile) {
        // ëª¨ë°”ì¼: ë°”ë¡œ ì›¹ ë·°ì–´ë¡œ ì´ë™
        statusText.textContent = 'ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€';
        statusDetail.textContent = 'ì›¹ ë·°ì–´ë¡œ ì´ë™í•©ë‹ˆë‹¤...';

        // ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (setTimeout ì—†ì´)
        redirectToWebViewer();
      } else {
        // ë°ìŠ¤í¬í†±: ì•± ì—´ê¸° ì‹œë„ í›„ ì›¹ í´ë°±
        tryOpenAppWithFallback();
      }
    }

    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    btnOpenApp.addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = getAppUrl();
    });

    btnOpenWeb.addEventListener('click', (e) => {
      e.preventDefault();
      redirectToWebViewer();
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', main);
    } else {
      main();
    }
  </script>
</body>
</html>
