# 실시간 협업 동기화 구현 계획

> Google Docs 스타일 협업 기능 고도화

---

## 요약

| Phase | 항목 | 수정 파일 | 이유 | 우선순위 | 상태 |
|-------|------|----------|------|---------|------|
| 1 | 기본 인프라 | collaboration-manager.js, app.js | Presence 추적, 기본 동기화 | 높음 | ✅ 완료 |
| 2 | 새로고침 없는 동기화 | review-data-manager.js, app.js | 비디오 유지하면서 데이터만 리로드 | 높음 | ✅ 완료 |
| 3 | 자동저장 시 머지 | review-data-manager.js | 덮어쓰기 방지 | 높음 | ✅ 완료 |
| 4 | 댓글 편집 잠금 | collaboration-manager.js, comment-manager.js, app.js | 동시 편집 충돌 방지 | 중간 | 🔄 진행중 |
| 5 | 동기화 간격 최적화 | collaboration-manager.js | 협업 시 반응성 향상 | 낮음 | ⬜ 대기 |

---

## 배경 및 목적

- **문제**: 여러 사용자가 동시에 .bframe 파일을 편집할 때 데이터 충돌/유실 가능
- **목표**: Google Docs처럼 매끄러운 동시 편집 경험 제공
- **제약**: Google Drive 동기화 지연 (수초~수십초)으로 인한 한계 존재

---

## 핵심 원칙: 협업자 감지 기반 활성화

모든 원격 기능은 `hasOtherCollaborators() === true`일 때만 동작:

| 기능 | 혼자 작업 | 협업자 있음 |
|------|----------|------------|
| Presence 업데이트 | O (감지용) | O |
| 자동 동기화 | X | O |
| 저장 시 머지 | X (바로 저장) | O |
| 편집 잠금 체크 | X | O |

**이유**: 혼자 작업할 때 불필요한 파일 I/O와 네트워크 부담 제거

---

### Phase 2: 새로고침 없는 데이터 동기화

**목표**: 비디오 유지하면서 .bframe 데이터만 리로드/머지

**수정 파일**:
- `renderer/scripts/modules/review-data-manager.js` - `reloadAndMerge()` 메서드 추가
- `renderer/scripts/app.js` - `remoteDataLoader` 콜백 개선

---

### Phase 3: 자동저장 시 머지

**목표**: 저장 전 원격 데이터 확인하여 덮어쓰기 방지

**수정 파일**:
- `renderer/scripts/modules/review-data-manager.js` - `save()` 수정, `_mergeBeforeSave()` 추가

---

### Phase 4: 댓글 편집 잠금

**목표**: 동시 편집 방지, 편집 중인 댓글에 잠금 표시

**수정 파일**:
- `renderer/scripts/modules/collaboration-manager.js` - `startEditing()`, `stopEditing()`, `isBeingEdited()` 추가
- `renderer/scripts/modules/comment-manager.js` - `setMarkerEditingState()` 추가
- `renderer/scripts/app.js` - 댓글 편집 UI 잠금 체크 (라인 4002~4052)

**.collab 스키마 확장**:
```javascript
{
  "presence": { ... },
  "editingState": {
    "marker_abc": {
      "sessionId": "xxx",
      "userName": "김철수",
      "startedAt": "2025-01-15T10:00:00Z"
    }
  }
}
```

---

### Phase 5: 동기화 간격 최적화

**목표**: 협업 활동량에 따라 동기화 간격 동적 조정

**간격 설정**:
- 혼자: 10초 (동기화 없음, presence만)
- 협업: 5초
- 활발: 3초 (1분 내 5회 이상 변경 시)

---

### 구현 순서

1. **Phase 2** - reloadAndMerge() 및 remoteDataLoader 개선
2. **Phase 3** - save() 머지 로직 추가
3. **Phase 4** - 편집 잠금 (가장 복잡)
4. **Phase 5** - 동기화 간격 최적화

---

### 예상 리스크 및 우려 사항

#### 1. Google Drive 동기화 지연 (높음)

**문제**:
- Google Drive는 파일 변경 후 클라우드 동기화까지 수초~수십초 소요
- A가 저장 → Drive 동기화 대기 → B가 로드 시 구버전 받을 수 있음

**영향**:
- 머지 로직이 있어도 "원격 데이터"가 실제로는 오래된 데이터일 수 있음
- 양쪽이 동시에 저장하면 나중 동기화된 쪽이 덮어쓸 수 있음

**완화책**:
- `modifiedAt` 타임스탬프 비교로 최신 판별
- 충돌 시 양쪽 데이터 모두 보존 (머지)
- 동기화 완료 전까지 토스트 경고 고려

---

#### 2. .collab 파일 경쟁 상태 (중간)

**문제**:
- 여러 사용자가 동시에 .collab 파일 읽기/쓰기 시 경쟁 조건 발생
- 파일 잠금 없이 동시 쓰기 → 데이터 손실 가능

**영향**:
- presence 정보 누락
- 편집 잠금 상태 불일치

**완화책**:
- 읽기-수정-쓰기를 최대한 빠르게 수행
- 실패 시 재시도 로직 (최대 3회)
- fail-open 정책: 실패해도 편집 허용

---

#### 3. 편집 잠금 해제 실패 (중간)

**문제**:
- 앱 강제 종료, 크래시 시 `stopEditing()` 호출 안 됨
- 편집 상태가 .collab에 남아 다른 사용자 편집 차단

**영향**:
- 60초 타임아웃까지 다른 사용자 편집 불가
- 타임아웃이 너무 짧으면 긴 편집 중 잠금 해제됨

**완화책**:
- 60초 타임아웃으로 자동 해제
- `beforeunload` 이벤트에서 `stopEditing()` 호출
- 주기적으로 편집 상태 갱신 (하트비트)

---

#### 4. 머지 충돌 해결 불완전 (중간)

**문제**:
- 현재 머지 전략: timestamp 기반 최신 우선
- 같은 댓글을 양쪽에서 다르게 수정 시 한쪽 내용 유실

**영향**:
- 사용자가 작성한 내용이 사라질 수 있음
- 특히 긴 댓글 수정 시 치명적

**완화책**:
- 편집 잠금으로 동시 수정 자체를 방지 (Phase 4)
- 충돌 발생 시 양쪽 내용 모두 보존하는 옵션 고려
- 삭제된 댓글은 soft delete로 복구 가능하게

---

#### 5. 대용량 파일 성능 (낮음)

**문제**:
- 댓글이 수백 개 이상일 때 머지 연산 부담
- 5초마다 파일 로드 시 I/O 부담

**영향**:
- 영상 재생 끊김 가능성 (매우 낮음)
- UI 버벅임

**완화책**:
- .bframe 파일은 일반적으로 10~100KB로 작음
- 비동기 처리로 메인 스레드 차단 방지
- 필요시 동기화 간격 동적 조정

---

#### 6. 오프라인 전환 (낮음)

**문제**:
- 협업 중 한 사용자가 오프라인으로 전환
- .collab 파일 업데이트 불가 → presence 정보 오래됨

**영향**:
- 오프라인 사용자가 여전히 "작업 중"으로 표시
- 15초 타임아웃 후 자동 제거되지만 그동안 혼란

**완화책**:
- 15초 타임아웃으로 오래된 presence 자동 제거 (이미 구현)
- 오프라인 감지 시 UI에 표시 고려

---

#### 7. 답글(Reply) 머지 복잡성 (낮음)

**문제**:
- 같은 댓글에 양쪽에서 다른 답글 추가 시 순서 문제
- 답글 삭제와 추가가 동시에 발생 시 불일치

**영향**:
- 답글 순서가 뒤섞일 수 있음
- 삭제된 답글이 다시 나타날 수 있음

**완화책**:
- `createdAt` 기준으로 답글 정렬
- 답글에도 soft delete 적용

---

### 리스크 요약

| 리스크 | 심각도 | 발생 확률 | 완화 가능성 |
|--------|--------|----------|------------|
| Google Drive 동기화 지연 | 높음 | 높음 | 중간 |
| .collab 경쟁 상태 | 중간 | 중간 | 높음 |
| 편집 잠금 해제 실패 | 중간 | 낮음 | 높음 |
| 머지 충돌 | 중간 | 중간 | 높음 |
| 대용량 파일 성능 | 낮음 | 낮음 | 높음 |
| 오프라인 전환 | 낮음 | 낮음 | 높음 |
| 답글 머지 | 낮음 | 낮음 | 중간 |

---

### 권장 사항

1. **Phase 4 (편집 잠금) 우선 구현**: 대부분의 머지 충돌을 사전에 방지
2. **토스트 알림 적극 활용**: 동기화 상태를 사용자에게 명확히 전달
3. **점진적 배포**: 팀 내 소수 인원으로 테스트 후 전체 배포
4. **로깅 강화**: 협업 관련 이벤트 상세 기록으로 문제 추적 용이하게

---

## 이전 작업 이력

### 2025-01-15: Phase 1 협업 기능 구현
- 협업자 presence 추적 (.bframe.collab 파일)
- 상단 협업자 아바타 표시
- 10초 자동 동기화 (협업자 감지 시)
- 댓글/레이어 머지 로직

### 2025-01-15: 타임코드 표시 부동소수점 오차 수정
- `Math.floor()` → `Math.round()` 변경
- 프레임 이동 시 정확한 타임코드 표시

### 2025-01-15: 트랜스코딩 색 공간 변환 추가
- FFmpeg colorspace 필터 추가
- mpeg4 영상의 색상 왜곡 문제 해결

### 2025-01-15: FFmpeg 인코더 자동 감지
- `ffmpeg -encoders` 출력 파싱
- H.264 인코더 우선순위 자동 선택
