# 2026-02-04 재생목록 핫픽스 완료 보고서

## 요약

| 항목 | 수정 파일 | 커밋 | 상태 |
|------|----------|------|------|
| Phase 1: EBUSY 변환 실패 수정 | `main/ffmpeg-manager.js` | `b279a18` | ✅ 완료 |
| Phase 2: 재생목록 데이터 소실 수정 | `playlist-manager.js`, `app.js` | `b279a18` | ✅ 완료 |
| Phase 3: 썸네일 캐시 미저장 수정 | `thumbnail-generator.js` | `b279a18` | ✅ 완료 |
| Phase 4: 사전 변환 시스템 구현 | `ffmpeg-manager.js`, `ipc-handlers.js`, `preload.js`, `app.js` | `b279a18` | ✅ 완료 |
| 추가 수정 1: EBUSY unlink 재시도 | `main/ffmpeg-manager.js` | `3b40943` | ✅ 완료 |
| 추가 수정 2: 썸네일 videoHash fallback | `main/ipc-handlers.js`, `thumbnail-generator.js` | `3b40943` | ✅ 완료 |
| 추가 수정 3: 오디오 디코딩 에러 필터링 | `renderer/scripts/app.js` | `3b40943` | ✅ 완료 |
| 추가 수정 4: transcodePromise TDZ 수정 | `main/ffmpeg-manager.js` | `769a76c` | ✅ 완료 |
| 추가 수정 5: 썸네일 캐시 mtime 보존 | `main/ffmpeg-manager.js` | `9354bd5` | ✅ 완료 |

---

## 배경

`DEVLOG/2026-02-04-재생목록-핫픽스.md`에 기술된 4가지 문제를 구현한 뒤, 실제 빌드 테스트에서 추가 버그 5건이 발견되어 총 4차에 걸쳐 수정 완료.

### 테스트 환경

| 경로 | 설명 |
|------|------|
| `C:\BAEFRAME` | 개발 경로 (`run-baeframe.bat` 실행) |
| `C:\BAEFRAME\dist\win-unpacked\` | 빌드된 앱 |
| `G:\공유 드라이브\JBBJ 자료실\...` | 팀원 공유 경로 |

---

## 커밋 이력

### 1차: `b279a18` — 재생목록 핫픽스 4종 수정

DEVLOG 계획에 따라 4개 Phase 구현.

**Phase 1 — EBUSY rename 재시도**
- `main/ffmpeg-manager.js`에 `_retryRename()` 메서드 추가
- `fs.renameSync` → 비동기 retry rename으로 교체 (최대 5회, 지수 딜레이)

**Phase 2 — 재생목록 데이터 소실 방지**
- `playlist-manager.js`의 `close()`에서 `playlistPath`가 null인 경우 localStorage 임시 저장
- `_saveToLocalStorage()`, `_restoreFromLocalStorage()`, `_clearLocalStorage()` 메서드 추가
- `app.js`에서 재생목록 재열기 시 localStorage 복원 로직 추가
- `state.currentFile.videoPath` → `state.currentFile` 수정 (문자열을 객체로 잘못 참조하던 버그)
- 자동 저장에서 `playlistPath` 없는 재생목록도 처리

**Phase 3 — 썸네일 캐시 Phase 1 저장**
- `thumbnail-generator.js`에서 Phase 1 완료 직후 `_saveToCache()` 호출 추가
- Phase 2가 abort 되어도 Phase 1 캐시는 보존됨

**Phase 4 — 사전 변환 시스템**
- `ffmpeg-manager.js`에 `preTranscode()` 메서드 추가
- `ipc-handlers.js`에 `ffmpeg:pre-transcode` IPC 핸들러 추가
- `preload.js`에 `ffmpegPreTranscode`, `onPreTranscodeProgress` API 추가
- `app.js`에 `preTranscodePlaylistItems()` 함수 및 영상 종료 시 자동 재생 추가

---

### 2차: `3b40943` — EBUSY unlink/썸네일 캐시/오디오 에러 실제 원인 수정

빌드 테스트에서 발견된 문제 3건.

**EBUSY unlink 재시도** — DEVLOG에서는 `rename`이 문제라고 분석했으나, 실제로는 `fs.unlinkSync(tempPath)` (ffmpeg-manager.js:513)에서 EBUSY 발생. 사전 변환이 파일을 점유하고 있는 상태에서 on-demand 변환이 같은 임시파일을 삭제하려 했기 때문.
- `_retryUnlink()` 메서드 추가 (최대 5회, 300ms × 시도횟수 딜레이)
- `fs.unlinkSync(tempPath)` 2곳을 `_retryUnlink()`로 교체

**썸네일 videoHash fallback** — `thumbnail:check-valid` IPC에서 `fs.stat()` 실패 시 `videoHash`를 반환하지 않아 렌더러에서 캐시 키를 생성할 수 없던 문제.
- `ipc-handlers.js`에서 stat 실패 시에도 `MD5(videoPath)` 기반 fallback hash 반환
- `thumbnail-generator.js`에서 `videoHash` null 방어 코드 추가

**오디오 디코딩 에러 필터링** — `PIPELINE_ERROR_DECODE: Failed to send audio packet for decoding` (code 3) 에러가 비치명적임에도 사용자에게 "비디오 재생 오류" 토스트를 표시하던 문제.
- `app.js`의 video error 이벤트 리스너에서 code 3 + "audio" 메시지 조합을 비치명적으로 분류, 경고 로그만 남기고 토스트 미표시

---

### 3차: `769a76c` — transcodePromise TDZ 오류 수정 및 중복 변환 방지 개선

**Temporal Dead Zone (TDZ) 오류** — `const transcodePromise = new Promise(...)` 구문에서, Promise 생성자 내부에서 `transcodePromise` 변수를 참조하면 초기화 전 접근(TDZ) 오류 발생. 앱 실행 후 변환이 필요한 파일을 열면 즉시 크래시.

```
Cannot access 'transcodePromise' before initialization
```

- `activeProcesses`에 promise를 저장하던 방식을 제거
- 별도 `pendingTranscodes` Map을 도입하여 Promise 생성 **후**에 등록
- 중복 변환 방지: `pendingTranscodes.has(filePath)` → 기존 Promise 반환
- `finally()`로 완료 시 자동 정리

---

### 4차: `9354bd5` — 썸네일 캐시 무효화 원인 수정 (checkCache mtime 보존)

**근본 원인** — 썸네일 캐시가 저장은 되지만 **매번 miss**되는 이유는 `checkCache()`에 있었음.

```javascript
// 변경 전: atime과 mtime 모두 현재 시각으로 변경
fs.utimesSync(convertedPath, new Date(), new Date());
```

썸네일 캐시 해시는 `MD5(filePath|fileSize|mtimeMs)`로 계산됨. `checkCache()`가 호출될 때마다 `mtime`이 변경되어 해시가 달라지고, 결과적으로 캐시가 항상 miss됨.

```javascript
// 변경 후: atime만 갱신하고 mtime은 보존
const convertedStats = fs.statSync(convertedPath);
fs.utimesSync(convertedPath, new Date(), convertedStats.mtime);
```

LRU 캐시 정리(`_cleanupCacheIfNeeded`)는 이미 `atimeMs` 기준이므로 호환성 문제 없음.

---

## 수정 파일 총정리

| 파일 | 수정 내용 | 커밋 |
|------|----------|------|
| `main/ffmpeg-manager.js` | `_retryRename()`, `_retryUnlink()`, `preTranscode()`, `pendingTranscodes` Map, `checkCache()` mtime 보존 | 1차~4차 전체 |
| `main/ipc-handlers.js` | `ffmpeg:pre-transcode` IPC 핸들러, `thumbnail:check-valid` fallback hash | 1차, 2차 |
| `preload/preload.js` | `ffmpegPreTranscode`, `onPreTranscodeProgress` API | 1차 |
| `renderer/scripts/modules/playlist-manager.js` | `close()` localStorage 저장, `_saveToLocalStorage()` 등 3개 메서드 | 1차 |
| `renderer/scripts/modules/thumbnail-generator.js` | Phase 1 캐시 저장, videoHash null 방어 | 1차, 2차 |
| `renderer/scripts/app.js` | localStorage 복원, `state.currentFile` 수정, 자동 저장 조건, 사전 변환, 자동 재생, 오디오 에러 필터링 | 1차, 2차 |

---

## 교훈 및 참고사항

### DEVLOG 분석 vs 실제 원인 차이

| DEVLOG 분석 | 실제 원인 |
|------------|----------|
| EBUSY는 `renameSync`에서 발생 | `unlinkSync`에서도 발생 (사전 변환과 on-demand 변환의 파일 충돌) |
| 썸네일은 Phase 2 abort 때문에 저장 안 됨 | 저장은 되지만 `checkCache()`가 mtime을 변경하여 매번 캐시 miss |

DEVLOG 계획의 수정만으로는 불충분했으며, 실제 빌드 테스트를 통해 4차에 걸친 반복 수정이 필요했음.

### 핵심 기술 포인트

1. **Windows 파일 잠금**: FFmpeg 프로세스 종료 후에도 파일 핸들이 즉시 해제되지 않을 수 있음. `unlink`/`rename` 모두 재시도 로직 필요.
2. **TDZ (Temporal Dead Zone)**: `const`로 선언된 변수는 선언문이 실행되기 전에 접근할 수 없음. Promise 생성자 내부에서 외부 변수를 참조할 때 주의.
3. **`fs.utimesSync(path, atime, mtime)`**: 두 번째 인자가 atime, 세 번째가 mtime. 둘 다 `new Date()`로 설정하면 mtime도 변경되어 mtime 기반 해시가 무효화됨.
4. **Chromium 오디오 에러**: `PIPELINE_ERROR_DECODE` code 3은 오디오 패킷 디코딩 실패이며, 영상 재생에는 영향 없는 비치명적 에러.
