# 3차 빌드 전 Claude 최종점검 문서 (교차검증용)

> 작성일: 2026-01-16
> 작성자: Claude (claude-opus-4-5-20251101)
> 목적: **교차검증을 위한 종합 분석 문서** - 다른 LLM 모델(GPT, Gemini, 다른 Claude 세션 등)이 코드베이스와 대조하여 검증 가능하도록 작성
> 브랜치: `claude/fix-canvas-crash-zjK8M`
> 기반 문서: `2026-01-16-코드-심층-분석-보고서.md`

---

## 문서 목적 및 사용 방법

### 이 문서의 목적

이 문서는 **다른 AI 모델이 BAEFRAME 코드베이스를 분석하고 이 문서의 내용을 교차검증**할 수 있도록 작성되었습니다. 각 문제에 대해 **정확한 파일 경로, 라인 번호, 문제 코드 스니펫, 검증 방법**을 포함합니다.

### 검증 모델에게 요청사항

1. 이 문서에 기술된 문제점들이 **실제로 코드에 존재하는지** 확인
2. 심각도 판단이 **적절한지** 검토
3. 누락된 중요한 문제점이 있는지 탐색
4. 제안된 해결책이 **적합한지** 평가
5. Claude의 편향이나 오판이 있는지 지적

### 컨텍스트 유지를 위한 핵심 정보

- **프로젝트**: BAEFRAME - 애니메이션 스튜디오용 비디오 리뷰/피드백 도구
- **기술 스택**: Electron 28 + mpv + Canvas API
- **데이터 형식**: `.bframe` JSON 파일 (Google Drive 동기화)
- **사용자**: 비개발자 애니메이터들 (오류 메시지 이해 어려움)

---

## 1. 프로젝트 구조

### 1.1 폴더 구조 (검증용)

```
BAEFRAME/
├── main/                    # Electron Main Process
│   ├── index.js            # 앱 진입점 (프로토콜 핸들링, 앱 종료)
│   ├── window.js           # BrowserWindow 설정 (창 표시 로직)
│   ├── ipc-handlers.js     # IPC 핸들러 (파일 I/O, 썸네일)
│   ├── ffmpeg-manager.js   # FFmpeg 관리 (트랜스코딩, 캐시)
│   ├── logger.js           # 로깅 시스템
│   ├── schema.js           # 데이터 스키마/마이그레이션
│   └── validators.js       # 데이터 검증
├── preload/
│   └── preload.js          # contextBridge API 정의
├── renderer/
│   ├── scripts/
│   │   ├── app.js          # 메인 UI 로직 (~5400줄)
│   │   └── modules/
│   │       ├── video-player.js      # 비디오 재생 제어
│   │       ├── timeline.js          # 타임라인 UI (~2100줄)
│   │       ├── drawing-canvas.js    # 캔버스 입력 처리
│   │       ├── drawing-manager.js   # 그리기 상태 관리
│   │       ├── drawing-layer.js     # 레이어 시스템
│   │       ├── comment-manager.js   # 댓글 관리
│   │       ├── collaboration-manager.js  # 협업 동기화
│   │       └── review-data-manager.js    # 데이터 저장/로드
│   └── styles/
├── web-viewer/             # 웹 뷰어 (Vercel 배포)
│   ├── scripts/app.js      # 웹 뷰어 로직
│   └── open.html           # 앱 열기 페이지
├── shared/
│   └── (validators.js가 있었으나 삭제됨)
└── mpv/                    # mpv 바이너리 (수정 금지)
```

### 1.2 최근 커밋 히스토리 (컨텍스트 유지용)

| 커밋 | 메시지 | 관련 파일 |
|------|--------|----------|
| 62e9871 | docs: 코드 심층 분석 보고서 작성 | DEVLOG |
| ddc32d7 | docs: 3차 빌드 전 교차검증용 최종점검 문서 작성 | DEVLOG |
| 565fa7b | fix: 그리기 도구 단축키(B, E) 사용 시 UI 탭도 함께 업데이트 | app.js |
| 45ebc84 | fix: 단축키 및 전체화면 모드 개선 | app.js |
| 7af5aec | feat: UI 개선 및 단축키 기능 확장 | app.js, timeline.js |

---

## 2. 발견된 문제점 요약

### 심각도 범례

| 배지 | 의미 | 설명 | 빌드 차단 여부 |
|:----:|------|------|:-------------:|
| 🔴 | 심각 (Critical) | 앱 크래시, 데이터 손실, 기능 완전 불가 | 권장 |
| 🟠 | 높음 (High) | 메모리 누수, 성능 저하, 부분 기능 장애 | 조기 수정 |
| 🟡 | 중간 (Medium) | 사용성 문제, 잠재적 버그, 보안 우려 | 모니터링 |
| 🟢 | 낮음 (Low) | 코드 품질, 유지보수성 | 향후 개선 |

### 문제 통계

| 심각도 | 발견 건수 | 설명 |
|--------|----------|------|
| 🔴 심각 | **10건** | 앱 크래시, 데이터 손실 가능. 즉시 수정 필요 |
| 🟠 높음 | **25건** | 기능 오작동, 성능 저하 가능. 조속히 수정 권장 |
| 🟢 경미 | **4건** | 사용성 개선 필요. 향후 개선 권장 |

---

## 3. 🔴 심각 (Critical) 문제 상세

### 3.1 Redo 버튼 버그 - 인덱스 오류로 화면 하얗게 됨

**검증 파일**: `renderer/scripts/modules/drawing-manager.js`
**검증 라인**: 314-316 (추정)
**상태**: ⬜ 대기

#### 문제 코드 (검증 필요)

```javascript
redo() {
  if (this.currentHistoryIndex < this.history.length - 1) {
    this.currentHistoryIndex++;
    // 🔴 문제: 인덱스가 증가된 후 잘못된 위치의 데이터를 참조할 수 있음
  }
}
```

#### 문제 설명

- Undo 후 새로운 그리기 작업을 하면 기존 히스토리가 잘려야 함
- 그러나 Redo 시 잘린 부분을 참조하려고 시도함
- 결과: 그리기 도구 사용 중 **화면이 하얗게 되거나 그린 내용이 사라짐**

#### 검증 방법

1. `drawing-manager.js` 파일에서 `redo()` 메서드 찾기
2. 히스토리 배열 경계 검사 로직 확인
3. 새 작업 추가 시 기존 히스토리 삭제 로직 확인 (`this.history.length = this.currentHistoryIndex + 1` 등)

#### 재현 시나리오

```
1. 그림 A 그리기
2. 그림 B 그리기
3. Ctrl+Z (Undo) → 그림 A만 보임
4. 그림 C 그리기 (새 작업)
5. Ctrl+Y (Redo) 시도 → 문제 발생
```

#### 예상 수정

```javascript
redo() {
  if (this.currentHistoryIndex < this.history.length - 1) {
    this.currentHistoryIndex++;
    const state = this.history[this.currentHistoryIndex];
    if (state) {
      this.restoreState(state);
    }
  }
}

// 새 작업 추가 시
addToHistory(state) {
  // 현재 위치 이후의 히스토리 삭제
  this.history.length = this.currentHistoryIndex + 1;
  this.history.push(state);
  this.currentHistoryIndex++;
}
```

---

### 3.2 자동저장 충돌 - 데이터 유실 가능

**검증 파일**: `renderer/scripts/modules/review-data-manager.js`
**검증 라인**: 693-710 (추정)
**상태**: ⬜ 대기

#### 문제 코드 (검증 필요)

```javascript
async autoSave() {
  // 🔴 문제: 이전 저장이 완료되기 전에 새 저장 시작 가능
  this.saveData();
}
```

#### 문제 설명

- 짧은 시간에 여러 번 저장하면 저장 순서가 꼬임
- 저장 완료를 기다리지 않고 다음 저장 시작
- 결과: **댓글이나 그림이 저장 안 되고 사라질 수 있음**

#### 검증 방법

1. `review-data-manager.js`에서 `autoSave()` 또는 `save()` 관련 메서드 찾기
2. `isSaving` 플래그 존재 여부 확인
3. `await` 키워드로 저장 완료 대기 여부 확인
4. 디바운스(debounce) 적용 여부 확인

#### 예상 수정

```javascript
// 방법 1: 저장 중 플래그
async autoSave() {
  if (this.isSaving) return;
  this.isSaving = true;
  try {
    await this.saveData();
  } finally {
    this.isSaving = false;
  }
}

// 방법 2: 디바운스
this.debouncedSave = debounce(this.saveData.bind(this), 1000);
```

---

### 3.3 댓글 이미지 손실 - 중복/누락

**검증 파일**: `renderer/scripts/app.js`
**검증 라인**: 839, 856 (추정)
**상태**: ⬜ 대기

#### 문제 설명

- 댓글에 첨부한 이미지 정보가 **여러 곳에서 따로 관리됨**
- 단일 진실 공급원(Single Source of Truth)이 아님
- 결과: **댓글에 이미지가 중복 첨부되거나 안 붙음**

#### 검증 방법

1. `app.js`에서 댓글 이미지 관련 코드 검색 (`comment.image`, `attachedImage` 등)
2. 이미지 상태가 어디에서 관리되는지 확인 (여러 곳이면 문제)
3. 이미지 첨부/삭제 로직에서 상태 동기화 여부 확인

---

### 3.4 앱 종료 불가 - X 버튼 무응답

**검증 파일**: `main/index.js`
**검증 라인**: 316-321 (추정)
**상태**: ⬜ 대기

#### 문제 코드 (검증 필요)

```javascript
app.on('before-quit', async (e) => {
  e.preventDefault();
  await cleanup(); // 🔴 문제: 무한 대기 가능
  app.quit();
});
```

#### 문제 설명

- 앱 종료 시 렌더러가 응답하지 않으면 `cleanup()`이 완료되지 않음
- 타임아웃이 없어서 무한 대기
- 결과: **X 버튼 눌러도 앱이 안 꺼짐, 작업관리자로 강제종료 필요**

#### 검증 방법

1. `main/index.js`에서 `before-quit` 또는 `will-quit` 이벤트 핸들러 찾기
2. `cleanup()` 함수에 타임아웃이 있는지 확인
3. 렌더러 응답 대기 로직 확인

#### 예상 수정

```javascript
app.on('before-quit', async (e) => {
  e.preventDefault();
  const timeout = setTimeout(() => {
    console.log('Cleanup timeout - forcing quit');
    app.exit(0);
  }, 30000); // 30초 타임아웃

  try {
    await cleanup();
  } finally {
    clearTimeout(timeout);
  }
  app.quit();
});
```

---

### 3.5 & 3.6 UI 멈춤 - 동기 파일 처리

**검증 파일**:
- `main/ffmpeg-manager.js` (라인 321, 332, 381, 393, 394, 446)
- `main/ipc-handlers.js` (라인 524-526, 678-679)

**상태**: ⬜ 대기

#### 문제 설명

- `fs.existsSync()`, `fs.mkdirSync()` 등 **동기 함수 사용**
- 메인 프로세스에서 동기 I/O는 렌더러 전체를 블로킹함
- 결과:
  - 큰 파일(2GB+) 열 때 **화면이 1~5초 멈춤**
  - 썸네일 100개 저장 시 **화면이 수 초 멈춤**

#### 검증 방법

```bash
# 동기 함수 사용 검색
grep -rn "fs.existsSync\|fs.mkdirSync\|fs.readFileSync\|fs.writeFileSync" main/
```

#### 예상 수정

```javascript
// Before (문제)
if (fs.existsSync(path)) { ... }
fs.mkdirSync(dir, { recursive: true });

// After (수정)
const exists = await fs.promises.access(path).then(() => true).catch(() => false);
await fs.promises.mkdir(dir, { recursive: true });
```

---

### 3.7 창 표시 충돌 - 깜빡임 또는 예상 못한 상태

**검증 파일**: `main/window.js`
**검증 라인**: 147-154 (추정)
**상태**: ⬜ 대기

#### 문제 설명

- 5초 타임아웃과 `ready-to-show` 이벤트가 **경쟁 상태(race condition)**
- 둘 다 동시에 발생하면 창이 두 번 표시됨
- 결과: **앱 시작 시 창이 두 번 깜빡이거나 예상 못한 상태**

#### 검증 방법

1. `window.js`에서 `ready-to-show` 이벤트 핸들러 찾기
2. `setTimeout`으로 타임아웃 설정 여부 확인
3. 한 번만 실행되도록 플래그가 있는지 확인

#### 예상 수정

```javascript
let windowShown = false;

win.once('ready-to-show', () => {
  if (!windowShown) {
    windowShown = true;
    clearTimeout(showTimeout);
    win.show();
  }
});

const showTimeout = setTimeout(() => {
  if (!windowShown) {
    windowShown = true;
    win.show();
  }
}, 5000);
```

---

### 3.8 FFmpeg 좀비 프로세스 - 메모리 누수

**검증 파일**: `main/ffmpeg-manager.js`
**검증 라인**: 497-500 (추정)
**상태**: ⬜ 대기

#### 문제 설명

- 영상 변환 취소 후 **프로세스가 완전히 정리 안 됨**
- stdin/stdout/stderr 스트림 정리 누락
- 결과: **메모리 사용량이 계속 증가, 오래 쓰면 앱이 느려짐**

#### 검증 방법

1. `ffmpeg-manager.js`에서 `kill()` 또는 프로세스 종료 관련 코드 찾기
2. 스트림 destroy 호출 여부 확인
3. `SIGKILL` 시그널 사용 여부 확인

#### 예상 수정

```javascript
killProcess(process) {
  process.stdin?.destroy();
  process.stdout?.destroy();
  process.stderr?.destroy();
  process.kill('SIGKILL');

  // 프로세스 참조 정리
  this.activeProcesses.delete(process.pid);
}
```

---

### 3.9 과거 파일 데이터 손실 - 마이그레이션 문제

**검증 파일**: `main/schema.js`
**검증 라인**: 252, 306-314 (추정)
**상태**: ⬜ 대기

#### 문제 설명

- 예전 버전 `.bframe` 파일 열 때 **잘못된 형식의 데이터를 빈 배열로 대체**
- 경고 없이 데이터 손실
- 결과: **예전에 작업한 하이라이트나 그림이 사라짐 (경고 없이)**

#### 검증 방법

1. `schema.js`에서 `migrate()` 또는 마이그레이션 관련 함수 찾기
2. 잘못된 형식 데이터 처리 로직 확인
3. 사용자 경고 또는 백업 로직 존재 여부 확인

#### 예상 수정

```javascript
// 마이그레이션 전 백업
async migrate(data, fromVersion) {
  // 백업 파일 생성
  await fs.promises.writeFile(
    `${filePath}.backup-v${fromVersion}`,
    JSON.stringify(data)
  );

  // 데이터 손실 경고
  if (hasInvalidData(data)) {
    log.warn('마이그레이션 중 일부 데이터가 호환되지 않습니다');
    // 사용자에게 알림
  }

  return migratedData;
}
```

---

### 3.10 검증 없이 저장 - 손상된 파일 생성

**검증 파일**: `main/validators.js`
**검증 라인**: 21-79 (추정)
**상태**: ⬜ 대기

#### 문제 설명

- 데이터 검증 결과를 **무시하고 저장할 수 있음**
- 검증 함수가 결과를 반환하지만 호출부에서 체크 안 함
- 결과: **손상된 데이터가 저장되어 나중에 파일이 안 열림**

#### 검증 방법

1. `validators.js`에서 검증 함수들 확인
2. 검증 함수 호출 위치에서 결과 처리 여부 확인
3. 검증 실패 시 저장 중단 로직 확인

---

## 4. 🟠 높음 (High) 문제 상세

### 4.1 캔버스 초기화 실패

**검증 파일**: `renderer/scripts/modules/drawing-canvas.js`
**검증 라인**: 31 (추정)

- 캔버스가 준비 안 된 상태에서 그리기 시도 가능
- 결과: **창 크기 조절 중 그리면 에러 발생**

---

### 4.2 영상 비율 오류

**검증 파일**: `renderer/scripts/modules/video-player.js`
**검증 라인**: 530 (추정)

- 영상 로딩 중 가로/세로가 0일 때 무한대 값 계산
- 결과: **영상이 찌그러져 보일 수 있음**

---

### 4.3 날짜 파싱 오류

**검증 파일**: `renderer/scripts/modules/review-data-manager.js`
**검증 라인**: 261-262 (추정)

- 날짜 정보가 없는 파일에서 NaN 값 발생
- 결과: **파일 병합 시 데이터가 잘못 합쳐질 수 있음**

---

### 4.4 탐색 플래그 오류

**검증 파일**: `renderer/scripts/modules/video-player.js`
**검증 라인**: 376-396 (추정)

- 빠르게 영상 위치를 이동하면 플래그 처리가 꼬임
- 결과: **타임라인 드래그 시 프레임 숫자가 흔들림**

---

### 4.5 레이어 ID 충돌

**검증 파일**: `renderer/scripts/modules/drawing-layer.js`
**검증 라인**: 75-87 (추정)

- 여러 파일을 빠르게 열면 레이어 번호가 겹칠 수 있음
- 결과: **다른 파일의 그림이 잘못된 레이어에 저장됨**

---

### 4.6 이미지 캐시 무한 증가

**검증 파일**: `renderer/scripts/modules/drawing-manager.js`
**검증 라인**: 686-706 (추정)

- 그리기 이미지가 메모리에 계속 쌓임
- LRU(Least Recently Used) 정책 없음
- 결과: **긴 영상 작업 시 앱이 점점 느려짐**

#### 검증 방법

```javascript
// 캐시 크기 제한 로직 존재 여부 확인
if (this.imageCache.size > MAX_CACHE_SIZE) {
  // 오래된 항목 삭제 로직
}
```

---

### 4.7 이벤트 리스너 누수 (DrawingCanvas)

**검증 파일**: `renderer/scripts/modules/drawing-canvas.js`
**검증 라인**: 73-85 (추정)

- 캔버스 교체 시 이전 이벤트가 정리 안 됨
- 결과: **창 크기 자주 바꾸면 메모리 누수**

#### 검증 방법 (중요)

```javascript
// destroy() 메서드에서 확인할 것:
// 1. AbortController 사용 여부
if (this.abortController) {
  this.abortController.abort();
}

// 2. 또는 removeEventListener 호출 여부
this.canvas.removeEventListener('mousedown', this.boundMouseDown);
```

**참고**: 2026-01-14에 "AbortController로 이벤트 리스너 정리" 커밋이 있음. **실제 수정 완료 여부 검증 필요**

---

### 4.8 Undo 저장 누락

**검증 파일**: `renderer/scripts/app.js`
**검증 라인**: 629-658 (추정)

- 실행취소 시 저장 완료를 기다리지 않음
- 결과: **Undo 후 바로 Redo하면 데이터 불일치**

---

### 4.9 레이어 UI 미갱신

**검증 파일**: `renderer/scripts/modules/drawing-manager.js`
**검증 라인**: 754-768 (추정)

- 파일 초기화 시 타임라인 UI 갱신이 보장 안 됨
- 결과: **새 파일 열 때 이전 레이어가 보일 수 있음**

---

### 4.10 로딩창 미닫힘

**검증 파일**: `main/index.js`
**검증 라인**: 157-163 (추정)

- 파일 로드 실패 시 로딩 창 닫기 누락
- 결과: **에러 시 로딩 화면이 계속 떠 있음**

---

### 4.11 렌더러 크래시 미복구

**검증 파일**: `main/window.js`
**검증 라인**: 172-175 (추정)

- 화면 프로세스 크래시 후 복구 안 됨
- 결과: **메모리 부족 시 앱이 먹통**

---

### 4.12 응답없음 미알림

**검증 파일**: `main/window.js`
**검증 라인**: 177-180 (추정)

- 앱이 멈춰도 사용자에게 알리지 않음
- 결과: **사용자가 어떻게 해야 할지 모름**

---

### 4.13 JSON 손상 미복구

**검증 파일**: `main/ipc-handlers.js`
**검증 라인**: 81-93 (추정)

- 손상된 `.bframe` 파일 열 때 복구 시도 없음
- 결과: **"오류 발생" 메시지만 나오고 파일을 못 염**

---

### 4.14 파일 감시 실패 미알림

**검증 파일**: `main/ipc-handlers.js`
**검증 라인**: 160-181 (추정)

- 파일 변경 감시 실패해도 알리지 않음
- 결과: **다른 사람이 파일 수정해도 알 수 없음**

---

### 4.15 프로토콜 링크 실패

**검증 파일**: `main/index.js`
**검증 라인**: 229 (추정)

- `baeframe://` 링크 열기 성공/실패 확인 안 함
- 결과: **Slack 링크 클릭해도 파일이 안 열리지만 에러 없음**

---

### 4.16 Slack 연동 멈춤

**검증 파일**: `main/ipc-handlers.js`
**검증 라인**: 1034-1050 (추정)

- Slack 정보 확인 시 동기 방식 사용
- 결과: **Slack 응답 느리면 UI 5초 이상 멈춤**

---

### 4.17 캐시 정리 실패 무시

**검증 파일**: `main/ffmpeg-manager.js`
**검증 라인**: 558 (추정)

- 캐시 정리 실패해도 무시함
- 결과: **캐시가 계속 쌓여 디스크 용량 부족**

---

### 4.18 캐시 정리 중 멈춤

**검증 파일**: `main/ffmpeg-manager.js`
**검증 라인**: 665-708 (추정)

- 큰 캐시 정리 시 동기 방식 사용
- 결과: **50GB 캐시 정리 시 UI 수 초 멈춤**

---

### 4.19 개별 취소 불가

**검증 파일**: `main/ffmpeg-manager.js`
**검증 라인**: 632-638 (추정)

- 여러 영상 변환 중 하나만 취소 불가능
- 결과: **여러 개 변환 시 모두 취소해야 함**

---

### 4.20 파일 감시 메모리 누수

**검증 파일**: `main/ipc-handlers.js`
**검증 라인**: 149-150 (추정)

- 파일 감시 정리 실패 시 메모리 누적
- 결과: **오래 사용하면 메모리 사용량 증가**

---

### 4.21 로그 저장 실패 무시

**검증 파일**: `main/logger.js`
**검증 라인**: 100-102 (추정)

- 로그 저장 실패해도 콘솔에만 출력
- 결과: **문제 발생 시 원인 파악 어려움**

---

### 4.22 이벤트 리스너 중복

**검증 파일**: `preload/preload.js`
**검증 라인**: 99-110 (추정)

- 같은 이벤트 핸들러 여러 번 등록 가능
- 결과: **파일 변경 시 같은 동작이 여러 번 실행**

---

### 4.23 오류 처리 불일치

**검증 파일**: `main/schema.js`
**검증 라인**: 180-197, 214-226 (추정)

- 함수마다 오류 처리 방식이 다름
- 결과: **일부 오류가 제대로 잡히지 않음**

---

### 4.24 NaN 검증 누락

**검증 파일**: `main/validators.js`
**검증 라인**: 155, 261-264 (추정)

- 숫자 필드에 NaN이 들어와도 통과
- 결과: **타임라인에서 댓글 위치가 이상해짐**

---

### 4.25 타입 검증 없음

**검증 파일**: `preload/preload.js`
**검증 라인**: 11-65 (추정)

- API 호출 시 파라미터 타입 검증 안 함
- 결과: **잘못된 타입 전달 시 에러 발생**

---

## 5. 🟢 경미 (Minor) 문제 상세

### 5.1 API 패턴 불일치

**검증 파일**: `preload/preload.js`
**검증 라인**: 70 (추정)

- 일부 API만 다른 방식 사용
- 결과: **개발자가 API 사용법 헷갈림**

---

### 5.2 영상 비율 0 처리

**검증 파일**: `renderer/scripts/modules/video-player.js`
**검증 라인**: 526-532 (추정)

- 영상 크기 0일 때 처리 없음
- 결과: **로딩 중 계산 오류 가능**

---

### 5.3 중첩 검증 누락

**검증 파일**: `main/validators.js`
**검증 라인**: 151-174 (추정)

- 답글의 내부 구조 검증 안 함
- 결과: **답글에 잘못된 데이터 저장 가능**

---

### 5.4 선택 필드 불명확

**검증 파일**: `main/validators.js`
**검증 라인**: 157-161 (추정)

- 어떤 필드가 선택인지 명확하지 않음
- 결과: **개발 시 혼란**

---

## 6. 추가 검증 필요 항목 (이전 리뷰에서 발견)

### 6.1 baeframe:// 프로토콜 URL 미스매치

**검증 파일**:
- `web-viewer/open.html` (라인 201-204 부근)
- `main/index.js` (라인 52-93 부근)

#### 문제 설명

웹 뷰어에서 생성하는 URL 형식과 데스크톱 앱이 파싱하는 형식이 불일치합니다.

```javascript
// web-viewer/open.html에서 생성하는 URL 형식
`baeframe://open?video=${videoUrl}&bframe=${bframeUrl}`

// main/index.js에서 처리하는 방식
let filePath = url.replace(/^baeframe:\/\//, '');
// → "open?video=..." 부분을 파일 경로로 해석 → 실패
```

**영향**: 웹 뷰어에서 "앱으로 열기" 버튼이 작동하지 않음

---

### 6.2 Timeline.destroy() 이벤트 리스너 누적

**검증 파일**: `renderer/scripts/modules/timeline.js`
**검증 메서드**: `destroy()` (라인 2111-2118 부근)

#### 누적되는 리스너 (검증 필요)

```javascript
// _setupEventListeners()에서 추가되는 리스너들
document.addEventListener('mousemove', ...)  // 플레이헤드 드래그
document.addEventListener('mouseup', ...)    // 드래그 종료

// _setupResizeObserver()에서 생성됨
new ResizeObserver(...)  // disconnect 미호출
```

**영향**: 파일 전환 반복 시 메모리 누수

---

### 6.3 copyFile/deleteFile API 누락

**검증 파일**:
- `renderer/scripts/modules/review-data-manager.js` (라인 307, 358 부근)
- `preload/preload.js`

```javascript
// review-data-manager.js에서 호출
await window.electronAPI.copyFile(sourcePath, destPath);
await window.electronAPI.deleteFile(filePath);

// preload.js에서 확인 필요: 이 함수들이 정의되어 있는가?
```

---

### 6.4 web-viewer XSS 취약점

**검증 파일**: `web-viewer/scripts/app.js` (라인 1816, 1824 부근)

```javascript
// text는 이스케이프됨
<div class="comment-text">${escapeHtml(comment.text)}</div>

// author는 이스케이프 안 됨 (문제)
<div class="comment-author">${comment.author || '익명'}</div>
```

---

## 7. 수정 우선순위 권장

### 1단계: 즉시 수정 (빌드 전 필수)

| 우선순위 | 문제 | 파일 | 수정 방안 |
|:--------:|------|------|----------|
| 1 | Redo 버그 | drawing-manager.js | 인덱스 계산 오류 수정 |
| 2 | 자동저장 충돌 | review-data-manager.js | 저장 완료 대기 로직 추가 |
| 3 | 앱 종료 불가 | index.js | 30초 타임아웃 추가 |
| 4 | baeframe:// 프로토콜 | index.js, open.html | URL 파싱 로직 수정 |
| 5 | Timeline destroy | timeline.js | 리스너 정리 추가 |

### 2단계: 조속히 수정 (빌드 후)

| 우선순위 | 문제 | 파일 | 수정 방안 |
|:--------:|------|------|----------|
| 1 | 동기 FS 호출 | ffmpeg-manager.js, ipc-handlers.js | fs.promises로 변경 |
| 2 | FFmpeg 프로세스 정리 | ffmpeg-manager.js | 스트림 destroy 추가 |
| 3 | 이미지 캐시 | drawing-manager.js | LRU 정책 적용 |
| 4 | copyFile/deleteFile | preload.js, ipc-handlers.js | API 추가 |
| 5 | web-viewer XSS | web-viewer/scripts/app.js | escapeHtml 적용 |

### 3단계: 향후 개선

| 우선순위 | 문제 | 파일 | 수정 방안 |
|:--------:|------|------|----------|
| 1 | 렌더러 크래시 복구 | window.js | 자동 복구 로직 |
| 2 | 에러 메시지 | 전반 | 사용자 친화적으로 개선 |
| 3 | API 타입 검증 | preload.js | 타입 검사 추가 |
| 4 | app.js 분리 | app.js | 모듈 분리 |

---

## 8. 테스트 체크리스트

### 8.1 기본 기능 테스트

- [ ] 앱 실행 시 에러 없이 로드되는지
- [ ] 비디오 파일 열기/재생/탐색 정상 동작
- [ ] 그리기 도구 (B키 → 브러시, E키 → 지우개) 동작
- [ ] 댓글 추가/수정/삭제 정상 동작
- [ ] 타임라인 줌/스크롤 정상 동작
- [ ] Ctrl+Z/Y Undo/Redo 동작
- [ ] 구간 반복 (I/O/L) 동작

### 8.2 크래시 시나리오 테스트

- [ ] Redo 버그: 그림 A → 그림 B → Undo → 그림 C → Redo
- [ ] 자동저장: 빠르게 연속 저장 시도 (Ctrl+S 연타)
- [ ] 앱 종료: X 버튼으로 종료 (30초 이내 종료되는지)
- [ ] 창 크기 조절 중 그리기 시도

### 8.3 메모리 누수 테스트

- [ ] 파일 전환 10회 반복 후 메모리 사용량 확인
- [ ] 개발자 도구 → Memory 탭 → Heap 스냅샷 비교
- [ ] Performance 탭으로 프레임 드랍 확인

### 8.4 프로토콜 링크 테스트

- [ ] 데스크톱에서 링크 복사 버튼 동작
- [ ] 복사된 링크로 앱 열기 시도
- [ ] 웹 뷰어에서 "앱으로 열기" 버튼 동작

---

## 9. Claude의 자체 한계 인정

### 9.1 이 문서의 잠재적 편향

1. **정보 출처 의존**: DEVLOG 문서들과 정적 분석 기반으로 작성. 실제 런타임 동작과 다를 수 있음
2. **심각도 판단**: 개인적 경험 기반으로 판단. 실제 사용 환경에서 다를 수 있음
3. **라인 번호**: 제시된 라인 번호는 **추정치**이며, 실제 코드와 다를 수 있음
4. **완료 여부**: DEVLOG에서 "완료"로 표시된 항목들이 실제로 수정되었는지 확인 필요
5. **문맥 누락**: 코드의 전체 문맥을 보지 못하고 단편적으로 분석했을 수 있음

### 9.2 교차검증 권장 항목

**반드시 코드로 확인해야 할 항목:**

1. `drawing-manager.js`의 `redo()` 메서드 경계 검사
2. `review-data-manager.js`의 저장 동시성 제어
3. `timeline.js`의 `destroy()` 메서드 이벤트 리스너 정리
4. `drawing-canvas.js`의 AbortController 적용 여부
5. `preload.js`의 `copyFile`/`deleteFile` 존재 여부
6. `web-viewer/scripts/app.js`의 `author` 필드 이스케이프 여부
7. `main/index.js`의 `baeframe://` 프로토콜 파싱 로직

---

## 10. 참고 문서

| 문서 | 경로 | 내용 |
|------|------|------|
| 개발 문서 | `baeframe-dev-docs.md` | 아키텍처, 기능 명세 |
| 코드 리뷰 검증 | `DEVLOG/2026-01-13-코드리뷰-검증.md` | GPT+Claude 리뷰 결과 |
| 협업 동기화 계획 | `DEVLOG/실시간-협업-동기화-구현-계획.md` | 협업 기능 상세 |
| UI 단축키 개선 | `DEVLOG/2026-01-16-UI-단축키-개선.md` | 최근 단축키 변경 |
| TODO | `TODO.md` | 전체 진행 상황 |
| 코드 심층 분석 | `DEVLOG/2026-01-16-코드-심층-분석-보고서.md` | 원본 분석 보고서 |

---

## 문서 끝

> 이 문서는 교차검증 목적으로 작성되었습니다.
> 다른 AI 모델은 이 문서의 내용을 **코드베이스와 직접 대조**하여 검증해주세요.
> 오류, 누락, 편향이 발견되면 지적해주세요.
>
> 작성: Claude (claude-opus-4-5-20251101)
> 날짜: 2026-01-16
