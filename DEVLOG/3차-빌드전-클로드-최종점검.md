# 3차 빌드 전 Claude 최종점검 문서

> 작성일: 2026-01-16
> 작성자: Claude (claude-opus-4-5-20251101)
> 목적: 교차검증을 위한 종합 분석 문서 - 다른 LLM 모델이 코드베이스와 대조하여 검증 가능하도록 작성
> 브랜치: `claude/fix-canvas-crash-zjK8M`

---

## 문서 목적 및 사용 방법

이 문서는 **다른 AI 모델(GPT, Codex, 다른 Claude 세션 등)이 BAEFRAME 코드베이스를 분석하고 이 문서의 내용을 교차검증**할 수 있도록 작성되었습니다.

### 검증 모델에게 요청사항

1. 이 문서에 기술된 문제점들이 **실제로 코드에 존재하는지** 확인
2. 심각도 판단이 **적절한지** 검토
3. 누락된 중요한 문제점이 있는지 탐색
4. 제안된 해결책이 **적합한지** 평가
5. Claude의 편향이나 오판이 있는지 지적

---

## 1. 프로젝트 개요

### 1.1 프로젝트 정보

| 항목 | 내용 |
|------|------|
| **프로젝트명** | BAEFRAME |
| **버전** | 0.1.0-alpha |
| **목적** | 애니메이션 스튜디오를 위한 비디오 리뷰/피드백 도구 |
| **기술 스택** | Electron 28 + mpv + Canvas API |
| **데이터 형식** | `.bframe` JSON 파일 (Google Drive 동기화) |
| **배포** | Desktop 앱 (Windows) + Web Viewer (Vercel) |

### 1.2 폴더 구조

```
BAEFRAME/
├── main/                    # Electron Main Process
│   ├── index.js            # 앱 진입점, 프로토콜 핸들링
│   ├── window.js           # BrowserWindow 설정
│   └── ipc-handlers.js     # IPC 핸들러들
├── preload/
│   └── preload.js          # 컨텍스트 브릿지
├── renderer/
│   ├── scripts/
│   │   ├── app.js          # 메인 로직 (~5400줄)
│   │   └── modules/        # 기능 모듈들
│   │       ├── video-player.js
│   │       ├── timeline.js
│   │       ├── drawing-canvas.js
│   │       ├── drawing-manager.js
│   │       ├── comment-manager.js
│   │       ├── collaboration-manager.js
│   │       └── review-data-manager.js
│   ├── styles/
│   └── index.html
├── web-viewer/              # 웹 뷰어 (Vercel 배포)
│   ├── scripts/app.js
│   └── open.html           # 앱 열기 페이지
├── shared/
│   └── schema.js           # 데이터 스키마
└── mpv/                    # mpv 바이너리 (수정 금지)
```

### 1.3 최근 커밋 히스토리 (15개)

| 커밋 | 메시지 | 관련 기능 |
|------|--------|----------|
| 565fa7b | fix: 그리기 도구 단축키(B, E) UI 탭 업데이트 | 단축키 |
| 45ebc84 | fix: 단축키 및 전체화면 모드 개선 | UI |
| 7af5aec | feat: UI 개선 및 단축키 기능 확장 | UI |
| 9a71c2f | fix: 댓글 오버레이 및 타임라인 구간 클릭 | 댓글 |
| 48aa3fd | debug: 타임라인 댓글 클릭 디버깅용 로그 | 디버그 |
| 4b56abe | fix: 타임라인 댓글 클릭 프리뷰 마커 효과 | 타임라인 |
| 804e0da | fix: 삭제 동기화 및 타임라인 댓글 클릭 | 협업 |
| 1c6a050 | fix: 삭제된 댓글 동기화 버그 수정 | 협업 |
| 3c7ca24 | feat: 파일 감시로 실시간 동기화 구현 | 협업 |
| 36ecad5 | fix: saveCurrentAnnotations 미정의 에러 | 버그 |
| 25077c2 | fix: 협업 동기화 및 UI 업데이트 개선 | 협업 |
| 5c5deb0 | fix: 협업 동기화 기능 개선 | 협업 |
| f02b382 | fix: 댓글 입력 및 트랜스코딩 썸네일 버그 | 버그 |
| 6224742 | fix: 썸네일 캐시 저장 시 file:// URL 처리 | 버그 |
| c9cb89c | fix: 협업 동기화 데이터 유실 버그 수정 | 협업 |

---

## 2. 현재 상태 요약

### 2.1 전체 진행률

| 구분 | 완료 | 미완료 | 진행률 |
|:----:|:----:|:------:|:------:|
| 핵심 기능 | 51개 | - | 100% |
| 버그 수정 | 18개 | 4개 | 82% |
| 코드 품질 | - | 여러 항목 | 진행중 |

### 2.2 완료된 주요 기능

- 비디오 재생/탐색 (mpv 기반)
- 그리기 레이어 (펜, 화살표, 지우개, 네모 브러시)
- 댓글 시스템 (추가/수정/삭제/스레드)
- 타임라인 (줌/스크롤/마커/키프레임)
- Undo/Redo 시스템
- 구간 반복 재생 (I/O/L)
- 협업 동기화 (Google Drive 기반)
- baeframe:// 프로토콜 링크 공유
- 버전 관리 (스플릿 뷰 비교)

### 2.3 미완료 주요 항목

| 항목 | 우선순위 | 상태 |
|------|:--------:|:----:|
| 댓글 가상 스크롤 (성능) | 높음 | TODO |
| baeframe:// 프로토콜 파싱 수정 | 높음 | TODO |
| Timeline.destroy() 리스너 정리 | 높음 | TODO |
| web-viewer XSS 수정 | 중간 | TODO |
| copyFile/deleteFile API | 중간 | TODO |
| validators.js 실제 적용 | 낮음 | TODO |

---

## 3. 발견된 문제점 상세

### 심각도 범례

| 배지 | 의미 | 설명 |
|:----:|------|------|
| 🔴 | 심각 | 앱 크래시, 데이터 손실, 기능 완전 불가 |
| 🟠 | 높음 | 메모리 누수, 성능 저하, 부분 기능 장애 |
| 🟡 | 중간 | 사용성 문제, 잠재적 버그, 보안 우려 |
| 🟢 | 낮음 | 코드 품질, 유지보수성 |

---

### 3.1 🔴 baeframe:// 프로토콜 URL 미스매치 (심각)

**검증 파일:**
- `web-viewer/open.html` (라인 201-204 부근)
- `main/index.js` (라인 52-93 부근)

**문제 설명:**

웹 뷰어에서 생성하는 URL 형식과 데스크톱 앱이 파싱하는 형식이 불일치합니다.

```javascript
// web-viewer/open.html에서 생성하는 URL 형식
`baeframe://open?video=${videoUrl}&bframe=${bframeUrl}`

// main/index.js에서 처리하는 방식
let filePath = url.replace(/^baeframe:\/\//, '');
// → "open?video=..." 부분을 파일 경로로 해석 → 실패
```

**영향:**
- 웹 뷰어에서 "앱으로 열기" 버튼이 작동하지 않음
- 링크 공유 기능의 핵심 흐름이 깨짐

**검증 방법:**
1. `web-viewer/open.html`에서 URL 생성 로직 확인
2. `main/index.js`에서 `baeframe://` 프로토콜 핸들링 코드 확인
3. 두 코드의 URL 형식 비교

**예상 수정:**
- `main/index.js`에서 query string 파싱 로직 추가
- 또는 `web-viewer/open.html`에서 URL 형식을 앱이 이해하는 형식으로 변경

---

### 3.2 🔴 Timeline.destroy() 이벤트 리스너 누적 (심각)

**검증 파일:**
- `renderer/scripts/modules/timeline.js`
- `destroy()` 메서드 (라인 2111-2118 부근)
- `_setupEventListeners()` 메서드
- `_setupResizeObserver()` 메서드

**문제 설명:**

Timeline 인스턴스가 파괴될 때 등록된 이벤트 리스너들을 제거하지 않습니다.

**누적되는 리스너 목록 (검증 필요):**

```javascript
// _setupEventListeners()에서 추가되는 리스너들
document.addEventListener('mousemove', ...)  // 플레이헤드 드래그
document.addEventListener('mouseup', ...)    // 드래그 종료

// _setupResizeObserver()에서 생성됨
new ResizeObserver(...)  // disconnect 미호출

// 레이어/마커 추가 시
header.addEventListener('click', ...)
marker.addEventListener('click', ...)
```

**영향:**
- 파일 전환을 반복하면 리스너가 계속 쌓임
- 장시간 사용 시 앱이 점점 느려짐
- 메모리 누수

**검증 방법:**
1. `timeline.js`의 `destroy()` 메서드에서 `removeEventListener` 호출 여부 확인
2. `ResizeObserver`의 `disconnect()` 호출 여부 확인
3. 개발자 도구에서 EventListener 탭으로 누적 확인 가능

---

### 3.3 🟠 copyFile/deleteFile API 누락 (높음)

**검증 파일:**
- `renderer/scripts/modules/review-data-manager.js` (라인 307, 358 부근)
- `preload/preload.js`

**문제 설명:**

`review-data-manager.js`에서 `window.electronAPI.copyFile()` 및 `deleteFile()`을 호출하지만, `preload.js`에 해당 함수가 정의되어 있지 않습니다.

```javascript
// review-data-manager.js에서 호출
await window.electronAPI.copyFile(sourcePath, destPath);
await window.electronAPI.deleteFile(filePath);

// preload.js에서 확인 필요
// copyFile, deleteFile 함수 정의 여부
```

**영향:**
- `TypeError: window.electronAPI.copyFile is not a function`
- 백업 파일 관리 기능 실패
- 콘솔에 에러 로그 누적

**검증 방법:**
1. `preload.js`에서 `copyFile`, `deleteFile` 함수 존재 여부 확인
2. `main/ipc-handlers.js`에서 해당 IPC 핸들러 존재 여부 확인

---

### 3.4 🟠 web-viewer XSS 취약점 (높음)

**검증 파일:**
- `web-viewer/scripts/app.js` (라인 1816, 1824 부근)

**문제 설명:**

댓글 작성자(author) 필드가 `escapeHtml()` 없이 innerHTML에 삽입됩니다.

```javascript
// 검증 필요: text는 이스케이프됨
<div class="comment-text">${escapeHtml(comment.text)}</div>

// 검증 필요: author는 이스케이프 안 됨
<div class="comment-author">${comment.author || '익명'}</div>
<div class="reply-author">${reply.author || '익명'}</div>
```

**영향:**
- 악성 .bframe 파일 공유 시 XSS 공격 가능
- 작성자 이름에 `<script>` 또는 `<img onerror=>` 삽입 시 실행됨

**검증 방법:**
1. `web-viewer/scripts/app.js`에서 `author` 필드 렌더링 부분 확인
2. `escapeHtml()` 함수 적용 여부 확인

---

### 3.5 🟠 DrawingCanvas 이벤트 리스너 문제 (확인 필요)

**검증 파일:**
- `renderer/scripts/modules/drawing-canvas.js`
- `_setupEventListeners()` 메서드 (라인 70-81 부근)
- `destroy()` 메서드 (라인 601-604 부근)

**문제 설명:**

이전 코드 리뷰에서 7개의 이벤트 리스너(mousedown, mousemove, mouseup, mouseleave, touchstart, touchmove, touchend)가 정리되지 않는다고 보고되었습니다.

**최근 수정 내역:**
- 2026-01-14에 "AbortController로 이벤트 리스너 정리" 커밋이 있음
- **검증 필요**: 실제로 수정이 완료되었는지 확인

**검증 방법:**
1. `drawing-canvas.js`에서 `AbortController` 사용 여부 확인
2. `destroy()` 메서드에서 `abort()` 호출 여부 확인
3. 또는 `removeEventListener` 호출 여부 확인

---

### 3.6 🟡 video.play() Promise 미처리 (확인 필요)

**검증 파일:**
- `renderer/scripts/modules/video-player.js` (라인 306 부근)

**문제 설명:**

`video.play()`는 Promise를 반환하며, 실패 시(코덱 문제, 브라우저 정책 등) 처리가 필요합니다.

**최근 수정 내역:**
- 2026-01-14에 "video.play() 에러 처리 - Promise catch 추가" 완료로 표시됨
- **검증 필요**: 실제로 수정이 완료되었는지 확인

**검증 방법:**
1. `video-player.js`에서 `play()` 호출 부분 확인
2. `.catch()` 또는 `try/catch` 처리 여부 확인

---

### 3.7 🟡 wheel passive 옵션 (확인 필요)

**검증 파일:**
- `renderer/scripts/modules/timeline.js` (라인 133 부근)

**문제 설명:**

wheel 이벤트에서 `preventDefault()`를 호출하려면 `{ passive: false }` 옵션이 필요합니다.

**최근 수정 내역:**
- 2026-01-14에 "wheel passive 옵션 - addEventListener 옵션 추가" 완료로 표시됨
- **검증 필요**: 실제로 수정이 완료되었는지 확인

**검증 방법:**
```javascript
// 이전 (문제)
element.addEventListener('wheel', handler);

// 수정 후 (정상)
element.addEventListener('wheel', handler, { passive: false });
```

---

### 3.8 🟡 validators.js 미사용 (중간)

**검증 파일:**
- `shared/validators.js` (파일 존재 여부)
- `renderer/scripts/modules/review-data-manager.js`

**문제 설명:**

데이터 검증 로직이 `shared/validators.js`에 정의되어 있으나, 실제로 사용되지 않는다고 보고되었습니다.

**참고:**
- 2026-01-09 커밋에서 `shared/validators.js`가 **삭제**되었을 수 있음
- DEVLOG에 "미사용 파일 삭제" 항목에 `shared/validators.js` 포함

**검증 방법:**
1. `shared/validators.js` 파일 존재 여부 확인
2. 존재한다면 `review-data-manager.js`에서 import/require 여부 확인

---

### 3.9 🟡 댓글 성능 (가상 스크롤 미구현)

**검증 파일:**
- `renderer/scripts/app.js`
- 댓글 렌더링 관련 함수

**문제 설명:**

댓글이 많아지면 (100개 이상) 성능 저하가 예상됩니다. Virtual Scrolling이 구현되어 있지 않습니다.

**최근 수정 내역:**
- "가상 스크롤 기본 구조 - virtualScrollState 추가, 100개 이상 경고" 완료로 표시됨
- 완전한 가상 스크롤 구현은 TODO 상태

**검증 방법:**
1. `app.js`에서 `virtualScrollState` 변수 존재 여부 확인
2. 댓글 100개 이상 시 경고 로직 확인

---

### 3.10 🟡 IPC 경로 검증 부재 (보안)

**검증 파일:**
- `main/ipc-handlers.js` 전반

**문제 설명:**

파일 경로를 받아서 처리할 때, 경로 검증(path traversal 방지 등)이 없습니다.

```javascript
// 잠재적 취약점 예시
ipcMain.handle('read-file', async (event, filePath) => {
  // filePath 검증 없이 바로 사용
  return fs.readFileSync(filePath);
});
```

**영향:**
- 이론적으로 `../../../etc/passwd` 같은 경로 접근 가능
- 내부 팀 도구이므로 실제 위험도는 낮음

**검증 방법:**
1. `ipc-handlers.js`에서 파일 경로를 받는 핸들러들 확인
2. 경로 검증 로직 유무 확인

---

### 3.11 🟡 하드코딩된 URL (유지보수성)

**검증 파일:**
- `main/ipc-handlers.js` (라인 349, 379 부근)

**문제 설명:**

웹 뷰어 URL이 코드에 직접 박혀있습니다.

```javascript
const webShareUrl = `https://baeframe.vercel.app/open.html?...`;
```

**영향:**
- URL 변경 시 코드 수정 필요
- 환경변수나 설정 파일로 분리 권장

---

### 3.12 🟢 app.js 파일 크기 (코드 품질)

**검증 파일:**
- `renderer/scripts/app.js`

**문제 설명:**

메인 로직 파일이 약 5,400줄로 매우 큽니다.

**영향:**
- 유지보수 어려움
- 버그 추적 어려움
- 당장의 기능 문제는 없음

---

## 4. 협업 기능 관련 컨텍스트

### 4.1 협업 동기화 시스템 개요

BAEFRAME은 Google Drive 동기화를 통한 협업 기능을 지원합니다.

**핵심 파일:**
- `renderer/scripts/modules/collaboration-manager.js`
- `renderer/scripts/modules/review-data-manager.js`

**동작 방식:**
1. `.bframe` 파일 옆에 `.bframe.collab` 파일 생성
2. Presence 정보 (누가 작업 중인지) 추적
3. 5~10초 간격으로 자동 동기화
4. 저장 시 머지 로직으로 충돌 방지

### 4.2 협업 관련 알려진 이슈

| 이슈 | 설명 | 완화책 |
|------|------|--------|
| Google Drive 동기화 지연 | 클라우드 동기화에 수초~수십초 소요 | timestamp 기반 최신 판별 |
| .collab 경쟁 상태 | 동시 쓰기 시 데이터 손실 가능 | fail-open 정책 |
| 편집 잠금 해제 실패 | 앱 강제 종료 시 잠금 유지 | 60초 타임아웃 |
| 오프라인 전환 | 협업 기능 동작 안 함 | 15초 타임아웃으로 제거 |

---

## 5. 단축키 시스템 컨텍스트

### 5.1 최근 변경된 단축키

| 단축키 | 이전 | 변경 후 |
|--------|------|--------|
| B | - | 그리기 모드 + 브러시 |
| E | - | 그리기 모드 + 지우개 |
| V | - | 그리기 모드 종료 |
| Shift+←/→ | 댓글 이동 | 10프레임 이동 |
| Ctrl+←/→ | - | 1초 이동 |
| D | 그리기 모드 | 유지 (B와 동일) |

### 5.2 단축키 설정 파일

**검증 파일:**
- `renderer/scripts/modules/user-settings.js`
- 단축키 기본값 정의 부분

---

## 6. 테스트 체크리스트

### 6.1 기본 기능 테스트

- [ ] 앱 실행 시 에러 없이 로드되는지
- [ ] 비디오 파일 열기/재생/탐색 정상 동작
- [ ] 그리기 도구 (B키 → 브러시, E키 → 지우개) 동작
- [ ] 댓글 추가/수정/삭제 정상 동작
- [ ] 타임라인 줌/스크롤 정상 동작
- [ ] Ctrl+Z/Y Undo/Redo 동작
- [ ] 구간 반복 (I/O/L) 동작

### 6.2 협업 기능 테스트

- [ ] 두 창에서 같은 파일 열기
- [ ] 한쪽에서 댓글 추가 → 다른 쪽에서 동기화 확인
- [ ] 편집 잠금 동작 확인

### 6.3 성능 테스트

- [ ] 파일 전환 10회 반복 후 메모리 사용량 확인
- [ ] 댓글 50개 이상 파일에서 성능 확인
- [ ] 개발자 도구 Performance 탭으로 프레임 드랍 확인

### 6.4 프로토콜 링크 테스트

- [ ] 데스크톱에서 링크 복사 버튼 동작
- [ ] 복사된 링크로 앱 열기 시도
- [ ] 웹 뷰어에서 "앱으로 열기" 버튼 동작

---

## 7. 파일별 검증 포인트 요약

| 파일 | 검증 포인트 | 예상 문제 |
|------|------------|----------|
| `main/index.js` | baeframe:// 프로토콜 파싱 | URL 형식 불일치 |
| `web-viewer/open.html` | URL 생성 로직 | 위와 연관 |
| `renderer/scripts/modules/timeline.js` | destroy() 리스너 정리 | 메모리 누수 |
| `renderer/scripts/modules/drawing-canvas.js` | destroy() AbortController | 수정 완료 여부 확인 |
| `preload/preload.js` | copyFile/deleteFile | 함수 미정의 |
| `web-viewer/scripts/app.js` | author escapeHtml | XSS 취약점 |
| `renderer/scripts/modules/video-player.js` | play() catch | 수정 완료 여부 확인 |

---

## 8. Claude의 자체 한계 인정

### 8.1 이 문서의 잠재적 편향

1. **정보 출처 의존**: DEVLOG 문서들을 신뢰하고 작성했으나, 실제 코드와 다를 수 있음
2. **심각도 판단**: 개인적 경험 기반으로 판단했으며, 실제 사용 환경에서 다를 수 있음
3. **라인 번호**: 제시된 라인 번호는 추정치이며, 실제 코드와 다를 수 있음
4. **완료 여부**: "완료"로 표시된 항목들이 실제로 수정되었는지 확인 필요

### 8.2 교차검증 권장 항목

1. **반드시 코드로 확인해야 할 항목:**
   - Timeline.destroy()의 이벤트 리스너 정리 여부
   - DrawingCanvas의 AbortController 적용 여부
   - preload.js의 copyFile/deleteFile 존재 여부
   - web-viewer의 author 필드 이스케이프 여부

2. **DEVLOG와 실제 코드 불일치 가능성:**
   - "완료"로 표시되었으나 실제 미완료일 수 있음
   - 커밋 메시지와 실제 변경 내용이 다를 수 있음

---

## 9. 권장 조치사항 (우선순위순)

### 9.1 빌드 전 필수 (🔴)

| # | 항목 | 파일 | 예상 시간 |
|---|------|------|----------|
| 1 | baeframe:// 프로토콜 파싱 수정 | `main/index.js`, `web-viewer/open.html` | 1-2시간 |
| 2 | Timeline.destroy() 리스너 정리 | `timeline.js` | 2-3시간 |

### 9.2 빌드 후 조기 수정 (🟠)

| # | 항목 | 파일 | 예상 시간 |
|---|------|------|----------|
| 3 | copyFile/deleteFile API 추가 | `preload.js`, `ipc-handlers.js` | 30분 |
| 4 | web-viewer XSS 수정 | `web-viewer/scripts/app.js` | 10분 |
| 5 | validators 재구현 또는 제거 | `shared/`, `review-data-manager.js` | 1시간 |

### 9.3 장기 개선 (🟡🟢)

| # | 항목 | 설명 |
|---|------|------|
| 6 | app.js 분리 | 유지보수성 향상 |
| 7 | IPC 경로 검증 | 보안 강화 |
| 8 | 댓글 가상 스크롤 | 대용량 성능 |
| 9 | 환경변수 URL | 배포 유연성 |

---

## 10. 참고 문서

| 문서 | 경로 | 내용 |
|------|------|------|
| 개발 문서 | `baeframe-dev-docs.md` | 아키텍처, 기능 명세 |
| 코드 리뷰 검증 | `DEVLOG/2026-01-13-코드리뷰-검증.md` | GPT+Claude 리뷰 결과 |
| 협업 동기화 계획 | `DEVLOG/실시간-협업-동기화-구현-계획.md` | 협업 기능 상세 |
| UI 단축키 개선 | `DEVLOG/2026-01-16-UI-단축키-개선.md` | 최근 단축키 변경 |
| TODO | `TODO.md` | 전체 진행 상황 |

---

## 문서 끝

> 이 문서는 교차검증 목적으로 작성되었습니다.
> 다른 AI 모델은 이 문서의 내용을 코드베이스와 직접 대조하여 검증해주세요.
> 오류, 누락, 편향이 발견되면 지적해주세요.
