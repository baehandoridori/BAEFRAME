# 실시간 협업 동기화 구현 계획

> Google Docs 스타일 협업 기능 고도화

---

## 요약

| Phase | 항목 | 수정 파일 | 이유 | 우선순위 | 상태 |
|-------|------|----------|------|---------|------|
| 1 | 기본 인프라 | collaboration-manager.js, app.js | Presence 추적, 기본 동기화 | 높음 | ✅ 완료 |
| 2 | 새로고침 없는 동기화 | review-data-manager.js, app.js | 비디오 유지하면서 데이터만 리로드 | 높음 | ✅ 완료 |
| 3 | 자동저장 시 머지 | review-data-manager.js | 덮어쓰기 방지 | 높음 | ✅ 완료 |
| 4 | 댓글 편집 잠금 | collaboration-manager.js, app.js | 동시 편집 충돌 방지 | 중간 | ✅ 완료 |
| 5 | 동기화 간격 최적화 | collaboration-manager.js, review-data-manager.js | 협업 시 반응성 향상 | 낮음 | ✅ 완료 |

---

## 배경 및 목적

- **문제**: 여러 사용자가 동시에 .bframe 파일을 편집할 때 데이터 충돌/유실 가능
- **목표**: Google Docs처럼 매끄러운 동시 편집 경험 제공
- **제약**: Google Drive 동기화 지연 (수초~수십초)으로 인한 한계 존재

---

## 핵심 원칙: 협업자 감지 기반 활성화

모든 원격 기능은 `hasOtherCollaborators() === true`일 때만 동작:

| 기능 | 혼자 작업 | 협업자 있음 |
|------|----------|------------|
| Presence 업데이트 | O (감지용) | O |
| 자동 동기화 | X | O |
| 저장 시 머지 | X (바로 저장) | O |
| 편집 잠금 체크 | X | O |

**이유**: 혼자 작업할 때 불필요한 파일 I/O와 네트워크 부담 제거

---

### Phase 2: 새로고침 없는 데이터 동기화

**목표**: 비디오 유지하면서 .bframe 데이터만 리로드/머지

**수정 파일**:
- `renderer/scripts/modules/review-data-manager.js` - `reloadAndMerge()` 메서드 추가
- `renderer/scripts/app.js` - `remoteDataLoader` 콜백 개선

---

### Phase 3: 자동저장 시 머지

**목표**: 저장 전 원격 데이터 확인하여 덮어쓰기 방지

**수정 파일**:
- `renderer/scripts/modules/review-data-manager.js` - `save()` 수정, `_mergeBeforeSave()` 추가

---

### Phase 4: 댓글 편집 잠금

**목표**: 동시 편집 방지, 편집 중인 댓글에 잠금 표시

**수정 파일**:
- `renderer/scripts/modules/collaboration-manager.js` - `startEditing()`, `stopEditing()`, `isBeingEdited()` 추가
- `renderer/scripts/modules/comment-manager.js` - `setMarkerEditingState()` 추가
- `renderer/scripts/app.js` - 댓글 편집 UI 잠금 체크 (라인 4002~4052)

**.collab 스키마 확장**:
```javascript
{
  "presence": { ... },
  "editingState": {
    "marker_abc": {
      "sessionId": "xxx",
      "userName": "김철수",
      "startedAt": "2025-01-15T10:00:00Z"
    }
  }
}
```

---

### Phase 5: 동기화 간격 최적화

**목표**: 협업 활동량에 따라 동기화 간격 동적 조정

**간격 설정**:
- 혼자: 10초 (동기화 없음, presence만)
- 협업: 5초
- 활발: 3초 (1분 내 5회 이상 변경 시)

---

### 구현 순서

1. **Phase 2** - reloadAndMerge() 및 remoteDataLoader 개선
2. **Phase 3** - save() 머지 로직 추가
3. **Phase 4** - 편집 잠금 (가장 복잡)
4. **Phase 5** - 동기화 간격 최적화

---

### 예상 리스크 및 우려 사항

#### 1. Google Drive 동기화 지연 (높음)

**문제**:
- Google Drive는 파일 변경 후 클라우드 동기화까지 수초~수십초 소요
- A가 저장 → Drive 동기화 대기 → B가 로드 시 구버전 받을 수 있음

**영향**:
- 머지 로직이 있어도 "원격 데이터"가 실제로는 오래된 데이터일 수 있음
- 양쪽이 동시에 저장하면 나중 동기화된 쪽이 덮어쓸 수 있음

**완화책**:
- `modifiedAt` 타임스탬프 비교로 최신 판별
- 충돌 시 양쪽 데이터 모두 보존 (머지)
- 동기화 완료 전까지 토스트 경고 고려

---

#### 2. .collab 파일 경쟁 상태 (중간)

**문제**:
- 여러 사용자가 동시에 .collab 파일 읽기/쓰기 시 경쟁 조건 발생
- 파일 잠금 없이 동시 쓰기 → 데이터 손실 가능

**영향**:
- presence 정보 누락
- 편집 잠금 상태 불일치

**완화책**:
- 읽기-수정-쓰기를 최대한 빠르게 수행
- 실패 시 재시도 로직 (최대 3회)
- fail-open 정책: 실패해도 편집 허용

---

#### 3. 편집 잠금 해제 실패 (중간)

**문제**:
- 앱 강제 종료, 크래시 시 `stopEditing()` 호출 안 됨
- 편집 상태가 .collab에 남아 다른 사용자 편집 차단

**영향**:
- 60초 타임아웃까지 다른 사용자 편집 불가
- 타임아웃이 너무 짧으면 긴 편집 중 잠금 해제됨

**완화책**:
- 60초 타임아웃으로 자동 해제
- `beforeunload` 이벤트에서 `stopEditing()` 호출
- 주기적으로 편집 상태 갱신 (하트비트)

---

#### 4. 머지 충돌 해결 불완전 (중간)

**문제**:
- 현재 머지 전략: timestamp 기반 최신 우선
- 같은 댓글을 양쪽에서 다르게 수정 시 한쪽 내용 유실

**영향**:
- 사용자가 작성한 내용이 사라질 수 있음
- 특히 긴 댓글 수정 시 치명적

**완화책**:
- 편집 잠금으로 동시 수정 자체를 방지 (Phase 4)
- 충돌 발생 시 양쪽 내용 모두 보존하는 옵션 고려
- 삭제된 댓글은 soft delete로 복구 가능하게

---

#### 5. 대용량 파일 성능 (낮음)

**문제**:
- 댓글이 수백 개 이상일 때 머지 연산 부담
- 5초마다 파일 로드 시 I/O 부담

**영향**:
- 영상 재생 끊김 가능성 (매우 낮음)
- UI 버벅임

**완화책**:
- .bframe 파일은 일반적으로 10~100KB로 작음
- 비동기 처리로 메인 스레드 차단 방지
- 필요시 동기화 간격 동적 조정

---

#### 6. 오프라인 전환 (낮음)

**문제**:
- 협업 중 한 사용자가 오프라인으로 전환
- .collab 파일 업데이트 불가 → presence 정보 오래됨

**영향**:
- 오프라인 사용자가 여전히 "작업 중"으로 표시
- 15초 타임아웃 후 자동 제거되지만 그동안 혼란

**완화책**:
- 15초 타임아웃으로 오래된 presence 자동 제거 (이미 구현)
- 오프라인 감지 시 UI에 표시 고려

---

#### 7. 답글(Reply) 머지 복잡성 (낮음)

**문제**:
- 같은 댓글에 양쪽에서 다른 답글 추가 시 순서 문제
- 답글 삭제와 추가가 동시에 발생 시 불일치

**영향**:
- 답글 순서가 뒤섞일 수 있음
- 삭제된 답글이 다시 나타날 수 있음

**완화책**:
- `createdAt` 기준으로 답글 정렬
- 답글에도 soft delete 적용

---

### 리스크 요약

| 리스크 | 심각도 | 발생 확률 | 완화 가능성 |
|--------|--------|----------|------------|
| Google Drive 동기화 지연 | 높음 | 높음 | 중간 |
| .collab 경쟁 상태 | 중간 | 중간 | 높음 |
| 편집 잠금 해제 실패 | 중간 | 낮음 | 높음 |
| 머지 충돌 | 중간 | 중간 | 높음 |
| 대용량 파일 성능 | 낮음 | 낮음 | 높음 |
| 오프라인 전환 | 낮음 | 낮음 | 높음 |
| 답글 머지 | 낮음 | 낮음 | 중간 |

---

### 권장 사항

1. **Phase 4 (편집 잠금) 우선 구현**: 대부분의 머지 충돌을 사전에 방지
2. **토스트 알림 적극 활용**: 동기화 상태를 사용자에게 명확히 전달
3. **점진적 배포**: 팀 내 소수 인원으로 테스트 후 전체 배포
4. **로깅 강화**: 협업 관련 이벤트 상세 기록으로 문제 추적 용이하게

---

## 이전 작업 이력

### 2025-01-15: Phase 1 협업 기능 구현
- 협업자 presence 추적 (.bframe.collab 파일)
- 상단 협업자 아바타 표시
- 10초 자동 동기화 (협업자 감지 시)
- 댓글/레이어 머지 로직

### 2025-01-15: 타임코드 표시 부동소수점 오차 수정
- `Math.floor()` → `Math.round()` 변경
- 프레임 이동 시 정확한 타임코드 표시

### 2025-01-15: 트랜스코딩 색 공간 변환 추가
- FFmpeg colorspace 필터 추가
- mpeg4 영상의 색상 왜곡 문제 해결

### 2025-01-15: FFmpeg 인코더 자동 감지
- `ffmpeg -encoders` 출력 파싱
- H.264 인코더 우선순위 자동 선택

### 2025-01-15: 협업 코드 리뷰 및 버그 수정
- `_modifiedAt` 미설정 버그 수정 (review-data-manager.js)
- `beforeunload` 핸들러 추가 (편집 잠금 해제)
- 중복 잠금 체크 제거 (성능 최적화)
- 키보드 단축키 중복 호출 방지

---

## 상세 테스트 방법

### 환경 준비

```bash
# 개발 모드 실행 (2개 창에서 각각 실행)
npm run dev
```

**요구사항**:
- 같은 .bframe 파일을 두 창에서 열어야 함
- Google Drive 동기화 폴더에 있으면 더 현실적인 테스트 가능

---

### 테스트 1: 협업자 감지

**목적**: Presence 추적이 정상 동작하는지 확인

**절차**:
1. 창 A에서 영상 파일 열기
2. 창 B에서 같은 영상 파일 열기
3. 5초 대기 (presence 업데이트 주기)

**예상 결과**:
- 상단에 협업자 아바타 2개 표시 (자신 + 상대방)
- 콘솔에 "다른 협업자 감지됨, 자동 동기화 시작" 로그

**확인 방법**:
```javascript
// 개발자 도구 콘솔에서
collaborationManager.getCollaborators()  // 2명 이상
collaborationManager.hasOtherCollaborators()  // true
```

---

### 테스트 2: 새로고침 없는 동기화

**목적**: 비디오 유지하면서 댓글만 동기화되는지 확인

**절차**:
1. 창 A와 B에서 같은 파일 열기
2. 창 A에서 새 댓글 추가 (위치: 00:00:05)
3. 창 B에서 동기화 버튼 클릭 (또는 5초 대기)

**예상 결과**:
- 창 B에서 비디오 위치 유지됨
- 창 B에 새 댓글이 나타남
- "새 댓글 1개가 동기화되었습니다" 토스트

**확인 방법**:
- 비디오 재생 위치가 변하지 않았는지 확인
- 댓글 목록에 새 댓글이 있는지 확인

---

### 테스트 3: 자동저장 머지

**목적**: 양쪽에서 다른 댓글 추가 시 모두 보존되는지 확인

**절차**:
1. 창 A와 B에서 같은 파일 열기
2. 창 A에서 댓글 추가: "창A의 댓글" (위치: 00:00:10)
3. 거의 동시에 창 B에서 댓글 추가: "창B의 댓글" (위치: 00:00:15)
4. 5~10초 대기 (자동 저장 + 동기화)

**예상 결과**:
- 양쪽 창 모두에서 2개의 댓글 확인 가능
- 어떤 댓글도 유실되지 않음

**확인 방법**:
```javascript
// 양쪽 창에서 실행
commentManager.getAllMarkers().length  // 2개 이상
```

---

### 테스트 4: 댓글 편집 잠금

**목적**: 동시 편집 방지가 작동하는지 확인

**절차**:
1. 창 A와 B에서 같은 파일 열기 (댓글 1개 이상 필요)
2. 창 A에서 댓글의 "수정" 버튼 클릭
3. 창 B에서 같은 댓글의 "수정" 버튼 클릭

**예상 결과**:
- 창 B에서 "OOO님이 수정 중입니다" 토스트 표시
- 창 B는 수정 모드에 진입하지 못함
- 창 A가 저장/취소 후 창 B에서 수정 가능

**확인 방법**:
```javascript
// 창 B 콘솔에서
await collaborationManager.isBeingEdited('마커ID')
// { isLocked: true, lockedBy: "창A사용자이름" }
```

---

### 테스트 5: 편집 잠금 타임아웃

**목적**: 60초 후 자동 잠금 해제 확인

**절차**:
1. 창 A에서 댓글 수정 모드 진입
2. 창 A를 **그대로 둠** (저장/취소 안 함)
3. 60초 대기
4. 창 B에서 같은 댓글 수정 시도

**예상 결과**:
- 60초 후 창 B에서 수정 가능
- 잠금이 타임아웃으로 자동 해제됨

---

### 테스트 6: beforeunload 잠금 해제

**목적**: 앱 종료 시 잠금 해제 확인

**절차**:
1. 창 A에서 댓글 수정 모드 진입
2. 창 A 탭/창 닫기 (X 버튼)
3. 즉시 창 B에서 같은 댓글 수정 시도

**예상 결과**:
- 창 B에서 즉시 수정 가능 (60초 타임아웃 대기 불필요)
- beforeunload 핸들러가 잠금 해제함

**주의**:
- 앱 강제 종료 (작업관리자 종료)는 beforeunload가 동작 안 함
- 이 경우 60초 타임아웃까지 대기 필요

---

### 테스트 7: 동기화 간격 동적 조정

**목적**: 활동량에 따라 동기화 간격 변경 확인

**절차**:
1. 창 A와 B에서 같은 파일 열기
2. 창 A에서 빠르게 댓글 5개 추가 (1분 내)
3. 콘솔에서 동기화 간격 확인

**예상 결과**:
- 활동량 많으면: 3초 간격
- 활동량 보통이면: 5초 간격
- 혼자 작업 시: 10초 간격 (동기화 비활성)

**확인 방법**:
```javascript
// 콘솔에서
collaborationManager.syncInterval  // 3000, 5000, 또는 10000
collaborationManager.recentActivityCount  // 최근 1분 내 활동 횟수
```

---

### 테스트 8: 머지 충돌 (같은 댓글 동시 수정)

**목적**: 같은 댓글을 양쪽에서 수정 시 최신 것이 유지되는지 확인

**절차**:
1. 창 A와 B에서 같은 파일 열기 (댓글 1개 필요)
2. **편집 잠금 테스트를 위해** 창 A에서 먼저 수정 완료
3. 창 B에서 같은 댓글 수정 (다른 내용으로)
4. 동기화 후 양쪽 확인

**예상 결과**:
- 편집 잠금으로 인해 동시 수정 자체가 방지됨
- 순차적으로 수정하면 최신 수정이 유지됨

---

### 테스트 9: 네트워크 오류 시나리오

**목적**: .collab 파일 접근 실패 시 동작 확인

**절차**:
1. 창 A에서 파일 열기
2. 파일 탐색기에서 `.bframe.collab` 파일 삭제
3. 창 A에서 댓글 수정 시도

**예상 결과**:
- 에러 없이 수정 가능 (fail-open 정책)
- 콘솔에 경고 로그만 출력
- 협업 기능은 동작 안 하지만 기본 기능은 정상

---

### 테스트 10: 대용량 파일 성능

**목적**: 댓글이 많을 때 성능 저하 없는지 확인

**절차**:
1. 댓글 50개 이상 있는 .bframe 파일 준비
2. 창 A와 B에서 열기
3. 비디오 재생하면서 동기화 동작 확인

**예상 결과**:
- 비디오 재생 끊김 없음
- 동기화 시 UI 버벅임 없음

**확인 방법**:
- 개발자 도구 > Performance 탭에서 프로파일링
- 프레임 드랍 확인

---

### 디버깅 팁

**로그 확인**:
```javascript
// 협업 이벤트 로그 확인
localStorage.debug = 'CollaborationManager:*';
```

**현재 상태 확인**:
```javascript
collaborationManager._isActive          // true면 협업 활성
collaborationManager.collabPath         // .collab 파일 경로
collaborationManager.getCollaborators() // 현재 협업자 목록
```

**.collab 파일 내용 확인**:
```bash
cat "파일경로.bframe.collab"
```

---

### 알려진 제한사항

1. **Google Drive 동기화 지연**: 클라우드 동기화에 수초~수십초 소요
2. **오프라인 시**: 협업 기능 동작 안 함, 온라인 복귀 후 자동 재개
3. **강제 종료 시**: 편집 잠금이 60초간 유지됨
